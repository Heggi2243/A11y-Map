<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login Page</title>
    <link rel="icon" href="img/a11y.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- ============================================= -->
     <script src="/js/firebase-config.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&display=swap" rel="stylesheet">
    <!-- tailwindCSS -->
    <link rel="stylesheet" href="/output.css">
    <link rel="stylesheet" href="./css/generic.css">
    <style>
      /* Custom Paper Texture Effect */
      
    

      /* Error Message */
      .error-message, .info-message {
        padding: 12px;
        border-radius: 8px;
        font-family: 'Fredoka', sans-serif;
        font-weight: 600;
        margin-bottom: 16px;
      }
      .error-message {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #dc2626;
        display: none;
      }
      .info-message {
        background: #dbeafe;
        color: #1e40af;
        border: 2px solid #3b82f6;
        display: none;
      }
      .error-message.show, .info-message.show {
        display: block;
      }
      .hidden { display: none !important; }
    </style>
  </head>
  <body class="min-h-screen w-full bg-paper relative overflow-hidden flex flex-col items-center justify-center selection:bg-[#fcd34d] selection:text-[#1e40af]">

    <!-- Sunburst Decoration -->
    <div id="Sunburst"></div>

    <!-- Main Content Wrapper -->
    <main class="relative z-10 w-full max-w-2xl flex flex-col items-center mb-20">
      
      <!-- Cat Decoration -->
      <div class="text-center mb-2 relative">
           <!-- Cat Decoration -->
          <div class="absolute -top-16 -left-4 md:-left-16 w-36 h-36 md:w-42 md:h-42 z-20 animate-bounce-slow">
          <img 
            src="img/cat.png" 
            id="knarfCat"
            alt="Black Cat Decoration" 
            class="w-full h-full object-contain drop-shadow-xl transform -rotate-12"
          />
        </div>

        <h1 class="font-titan text-[#1e40af] text-[5rem] md:text-[8rem] leading-[0.8] tracking-tighter drop-shadow-sm select-none">
          <div>LOGIN</div>
          <div>PAGE</div>
        </h1>
      </div>

      <!-- Form Section -->
      <form 
        id="loginForm"
        class="relative w-full max-w-md flex flex-col gap-6 p-8 z-10"
      >
        <!-- Error & Info Message -->
        <div id="errorMessage" class="error-message"></div>

        <div class="flex flex-col gap-4">
          <div>
            <!-- Email Input -->
            <label for="email" class="sr-only">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              placeholder="EMAIL"
              required
              class="w-full h-14 px-4 rounded-xl border-4 border-[#1e40af] bg-white font-fredoka font-bold text-[#1e40af] text-lg placeholder-[#1e40af]/50 focus:outline-none focus:ring-4 focus:ring-[#fcd34d] transition-all shadow-[4px_4px_0px_0px_#1e40af]"
            />
          </div>
          
          <div>
            <label for="password" class="sr-only">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="PASSWORD"
              required
              class="w-full h-14 px-4 rounded-xl border-4 border-[#1e40af] bg-white font-fredoka font-bold text-[#1e40af] text-lg placeholder-[#1e40af]/50 focus:outline-none focus:ring-4 focus:ring-[#fcd34d] transition-all shadow-[4px_4px_0px_0px_#1e40af]"
            />
          </div>
        </div>

        <button
          type="submit"
          id="submitBtn"
          class="w-full h-16 mt-2 rounded-full bg-[#1e40af] text-white font-titan text-2xl tracking-wide hover:bg-[#1e3a8a] hover:scale-[1.02] active:scale-[0.98] transition-all shadow-[4px_4px_0px_0px_#000000] border-2 border-transparent flex items-center justify-center cursor-pointer"
        >
          ENTER
        </button>
        
      </form>
      
    </main>

    <div class="absolute bottom-0 w-full">
      <div class="absolute bottom-20 right-10 md:right-1/4 w-48 h-48 md:w-56 md:h-56 z-20 animate-wiggle">
          <img 
             src="img/dog.png" 
             alt="Running Dog Decoration" 
             class="w-full h-full object-contain drop-shadow-xl transform scale-x-[-1]"
           />
      </div>

    <footer class="w-full mt-auto">
        <div class="w-full h-16 md:h-24 flex flex-wrap overflow-hidden border-t-4 border-blue-900 checkerboard-pattern">
            </div>
        <div class="copyright-bar">
            æš¢è¡Œç„¡é˜» A11y-Map Â© 2025
        </div>
    </footer>
    <script type="module">
      import { createSun } from '/layout/backend.js';
      document.getElementById('Sunburst').innerHTML = createSun();
    </script>
    </div>

    <script>


      firebase.initializeApp(FIREBASE_CONFIG);

      // ========== æ–°å¢ï¼šåˆå§‹åŒ– reCAPTCHA ========== //
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
  console.log('æœ¬åœ°é–‹ç™¼æ¨¡å¼ï¼šå•Ÿç”¨ App Verification ç¹é');
  
  // ä½¿ç”¨æ¸¬è©¦æ¨¡å¼çš„ reCAPTCHA
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('submitBtn', {
    'size': 'invisible',
    'callback': (response) => {
      console.log('reCAPTCHA é©—è­‰å®Œæˆ');
    },
    'error-callback': (error) => {
      console.error('reCAPTCHA éŒ¯èª¤:', error);
    }
  });
  
  // é—œéµï¼šè¨­å®š App Verification Disabledï¼ˆåƒ…é™é–‹ç™¼ç’°å¢ƒï¼‰
  firebase.auth().settings.appVerificationDisabledForTesting = true;
  
} else {
  // æ­£å¼ç’°å¢ƒçš„ reCAPTCHA è¨­å®š
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('submitBtn', {
    'size': 'invisible',
    'callback': (response) => {
      console.log('reCAPTCHA é©—è­‰å®Œæˆ');
    }
  });
}
    // =========================================== //
      
      const db = firebase.firestore();

      document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = document.getElementById('submitBtn');
        const errorMsg = document.getElementById('errorMessage');
        const originalText = btn.innerText;

        errorMsg.classList.remove('show');

        btn.disabled = true;
        btn.innerText = 'LOADING...';
        btn.classList.add('opacity-80', 'cursor-not-allowed');

        try {
          const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
          
          console.log('ç™»å…¥æˆåŠŸ:', userCredential.user.email);
          
          // ========== æ–°å¢ 3/4ï¼šå‘¼å«è¨˜éŒ„ Session å‡½å¼ ========== //
          await recordLoginSession(userCredential.user);
          // ==================================================== //
          
          window.location.href = '/admin.html';
          
        } catch (error) {
         console.error('ç™»å…¥éŒ¯èª¤:', error);
  
  if (error.code === 'auth/multi-factor-auth-required') {
    console.log('éœ€è¦MFAé©—è­‰');
    
    try {
      const resolver = error.resolver;
      
      if (!resolver.hints || resolver.hints.length === 0) {
        throw new Error('æ‰¾ä¸åˆ°å¯ç”¨çš„ MFA é©—è­‰æ–¹å¼');
      }
      
      const phoneInfoOptions = {
        multiFactorHint: resolver.hints[0],
        session: resolver.session
      };
      
      const phoneAuthProvider = new firebase.auth.PhoneAuthProvider();
      
      console.log('ğŸ“± ç™¼é€é©—è­‰ç¢¼åˆ°:', resolver.hints[0].phoneNumber);
      
      // ç™¼é€é©—è­‰ç¢¼
      const verificationId = await phoneAuthProvider.verifyPhoneNumber(
        phoneInfoOptions,
        window.recaptchaVerifier
      );
      
      console.log('âœ… é©—è­‰ç¢¼å·²ç™¼é€ï¼ŒverificationId:', verificationId);
      
      // å„²å­˜è³‡è¨Šä¾›å¾ŒçºŒé©—è­‰ä½¿ç”¨
      window.mfaResolver = resolver;
      window.mfaVerificationId = verificationId;
      
      // æç¤ºç”¨æˆ¶è¼¸å…¥é©—è­‰ç¢¼
      const code = prompt('è«‹è¼¸å…¥ç°¡è¨Šé©—è­‰ç¢¼ï¼ˆ6ä½æ•¸å­—ï¼‰:');
      
      if (code) {
        // å»ºç«‹é©—è­‰æ†‘è­‰
        const cred = firebase.auth.PhoneAuthProvider.credential(verificationId, code);
        const multiFactorAssertion = firebase.auth.PhoneMultiFactorGenerator.assertion(cred);
        
        // å®Œæˆ MFA é©—è­‰
        const userCredential = await resolver.resolveSignIn(multiFactorAssertion);
        
        console.log('âœ… MFA é©—è­‰æˆåŠŸ:', userCredential.user.email);
        
        await recordLoginSession(userCredential.user);
        window.location.href = '/admin.html';
      }
      
    } catch (mfaError) {
      console.error('âŒ MFA è™•ç†å¤±æ•—:', mfaError);
      errorMsg.textContent = 'é©—è­‰å¤±æ•—: ' + (mfaError.message || 'è«‹ç¨å¾Œå†è©¦');
      errorMsg.classList.add('show');
    }
    
    btn.disabled = false;
    btn.innerText = originalText;
    btn.classList.remove('opacity-80', 'cursor-not-allowed');
    return;
  }
  // ================================= //
          
          let errorMessage = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„å¸³è™Ÿå¯†ç¢¼';
          
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'å¯†ç¢¼éŒ¯èª¤';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Email æ ¼å¼ä¸æ­£ç¢º';
          } else if (error.code === 'auth/user-disabled') {
            errorMessage = 'æ­¤å¸³è™Ÿå·²è¢«åœç”¨';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦';
          }
          
          errorMsg.textContent = errorMessage;
          errorMsg.classList.add('show');
          
          btn.disabled = false;
          btn.innerText = originalText;
          btn.classList.remove('opacity-80', 'cursor-not-allowed');
        }
      });

    // ==================== Sessionè¨˜éŒ„ ==================== //

    
    /**
     * 1. ç”Ÿæˆè£ç½®æŒ‡ç´‹ï¼Œçµåˆå¤šç¨®ç€è¦½å™¨ç‰¹å¾µä¾†ç”¢ç”Ÿå”¯ä¸€è­˜åˆ¥ç¢¼
     * 2. åŒä¸€å€‹ipç„¡æ³•å€åˆ†"åŒä¸€å€‹äººç”¨ä¸åŒè£ç½®"æˆ–æ˜¯"ä¸åŒäººç”¨åŒä¸€å€‹ç¶²è·¯"
     * 3. æŒ‡ç´‹è£ç½®ï¼šipæ”¹è®Šæ™‚ä»èƒ½è­˜åˆ¥åŒä¸€è£ç½®ï¼Œåˆ¤æ–·ç™»å…¥ç•°å¸¸ã€æˆ–å¾ä½¿ç”¨è€…ç¿’æ…£åˆ¤æ–·æ˜¯å¦ç•°å¸¸
     * 4. é›–ç„¶é˜²ä¸äº†é ç«¯æ¡Œé¢ï¼Œä½†é€šå¸¸æƒ…æ³è£ç½®æŒ‡ç´‹é›£ä»¥è¢«å½é€ ï¼Œå¯ä»¥å¤šä¸€å€‹åˆ¤æ–·
     * 5. ç¬¦åˆä½¿ç”¨è€…éš±ç§ï¼šä¸è’é›†å€‹äººè³‡è¨Šï¼Œåªè’é›†è£ç½®ï¼Œç„¡æ³•åå‘æ¨è«–ç®¡ç†å“¡èº«åˆ†
     */
    function generateDeviceFingerprint() {
      // æ”¶é›†è£ç½®ç‰¹å¾µ
      const features = [
        navigator.userAgent, //ç€è¦½å™¨
        navigator.language,  //èªè¨€è¨­å®š
        screen.width + 'x' + screen.height, // è¢å¹•è§£æåº¦(EX:1920x1080)ï¼Œæ›è¢å¹•æ©Ÿç‡ä½
        screen.colorDepth,  //è‰²å½©æ·±åº¦
        new Date().getTimezoneOffset(),  //æ™‚å€åç§»
        navigator.hardwareConcurrency || 0, //CPU(é™¤éæ›é›»è…¦)
        navigator.platform //ä½œæ¥­ç³»çµ±(EX:Win32)
      ];

      /**
       * çµ„åˆæˆå­—ä¸²ï¼š
       * fingerprint = "Mozilla/5.0...|zh-TW|1920x1080|24|-480|8|Win32"
      */
      
      // ç¸®æˆçŸ­çš„hashå€¼
      const fingerprint = features.join('|');
      let hash = 0;
      for (let i = 0; i < fingerprint.length; i++) {
        const char = fingerprint.charCodeAt(i); //ASCIIç¢¼
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // è½‰æ›ç‚º32ä½å…ƒæ•´æ•¸
      }
      
      return Math.abs(hash).toString(36); // è½‰ç‚º36é€²ä½å­—ä¸²
    }

      /**
       * è¨˜éŒ„ç™»å…¥ Session
       * åŒ…å«ï¼šæ—¥æœŸæ™‚é–“ã€ç®¡ç†å“¡(email+UID)ã€IPã€è£ç½®(OS)ã€ç€è¦½å™¨ã€ç‹€æ…‹
       */
      async function recordLoginSession(user) {
      try {
        // 1. ç”Ÿæˆè£ç½®æŒ‡ç´‹
        const deviceFingerprint = generateDeviceFingerprint();
        console.log('ğŸ” è£ç½®æŒ‡ç´‹:', deviceFingerprint);
        
        // 2. æ›´æ–°ä¸Šæ¬¡æœªçµæŸçš„ session ç‚º browser_closed
        const previousSessions = await db.collection('login_sessions')
          .where('uid', '==', user.uid)
          .where('status', '==', 'active')
          .get();
        
        if (!previousSessions.empty) {
          const batch = db.batch();
          previousSessions.forEach(doc => {
            batch.update(doc.ref, { 
              status: 'browser_closed',
              endTime: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          await batch.commit();
        }
        
        // 3. è§£æç€è¦½å™¨å’Œä½œæ¥­ç³»çµ±
        const ua = navigator.userAgent;
        let browser = 'Unknown';
        let os = 'Unknown';
        
        if (ua.includes('Chrome') && !ua.includes('Edg')) browser = 'Chrome';
        else if (ua.includes('Firefox')) browser = 'Firefox';
        else if (ua.includes('Safari') && !ua.includes('Chrome')) browser = 'Safari';
        else if (ua.includes('Edg')) browser = 'Edge';
        
        if (ua.includes('Windows')) os = 'Windows';
        else if (ua.includes('Mac')) os = 'macOS';
        else if (ua.includes('Linux')) os = 'Linux';
        else if (ua.includes('Android')) os = 'Android';
        else if (ua.includes('iOS')) os = 'iOS';

        // 4. å–å¾— IP ä½å€
        let ipAddress = 'unknown';
        try {
          const ipResponse = await fetch('https://api.ipify.org?format=json');
          const ipData = await ipResponse.json();
          ipAddress = ipData.ip;
          console.log('ğŸ”„ é–‹å§‹è¨˜éŒ„ Session...');
          console.log('User UID:', user.uid);
          console.log('User Email:', user.email);
          console.log('IP Address:', ipAddress);
        } catch (e) {
          console.warn('ç„¡æ³•å–å¾— IP');
        }

        // 5. å»ºç«‹ session è¨˜éŒ„ (åŠ å…¥ deviceFingerprint)
        const sessionData = {
          uid: user.uid,
          email: user.email,
          loginTime: firebase.firestore.FieldValue.serverTimestamp(),
          ipAddress: ipAddress,
          browser: browser,
          os: os,
          deviceFingerprint: deviceFingerprint,  // â† åŠ å…¥é€™å€‹
          deviceInfo: {  // â† é¡å¤–çš„è£ç½®è³‡è¨Š
            platform: navigator.platform,
            userAgent: navigator.userAgent,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            screenResolution: `${screen.width}x${screen.height}`
          },
          status: 'active',
          endTime: null
        };

        const sessionRef = await db.collection('login_sessions').add(sessionData);
        sessionStorage.setItem('currentSessionId', sessionRef.id);
        
        console.log('Session è¨˜éŒ„æˆåŠŸ:', sessionRef.id);
        
      } catch (error) {
        console.error('âŒ Session è¨˜éŒ„å¤±æ•—:', error);
      }
    }
          
      // ================================================================== //
    </script>
  </body>
</html>